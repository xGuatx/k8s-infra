---
- name: Configure Security (Network Policies, RBAC, Secrets Encryption)
  hosts: k8s-orchestrator.example.com
  become: no
  gather_facts: no
  connection: local

  vars:
    kubeconfig: "{{ playbook_dir }}/../kubeconfig.yaml"

  environment:
    KUBECONFIG: "{{ kubeconfig }}"

  tasks:
    # 1. Configure Secrets Encryption at Rest on K3s master
    - name: Create encryption configuration
      delegate_to: "{{ groups['k3s_masters'][0] }}"
      become: yes
      copy:
        dest: /etc/rancher/k3s/encryption-config.yaml
        content: |
          apiVersion: apiserver.config.k8s.io/v1
          kind: EncryptionConfiguration
          resources:
            - resources:
                - secrets
              providers:
                - aescbc:
                    keys:
                      - name: key1
                        secret: {{ vault_k3s_encryption_key }}
                - identity: {}

    - name: Verifier le statut du chiffrement des secrets
      delegate_to: "{{ groups['k3s_masters'][0] }}"
      become: yes
      command: k3s secrets-encrypt status
      register: secrets_encrypt_status
      changed_when: false

    - name: Activer le chiffrement des secrets (si necessaire)
      delegate_to: "{{ groups['k3s_masters'][0] }}"
      become: yes
      command: k3s secrets-encrypt enable
      when: "'Encryption Status: Enabled' not in secrets_encrypt_status.stdout"

    - name: Redemarrer le service k3s pour appliquer le chiffrement
      become: yes
      delegate_to: "{{ item }}"
      loop: "{{ groups['k3s_masters'] }}"
      loop_control:
        label: "Restarting {{ item }}"
      command: systemctl restart k3s
      when: "'Encryption Status: Enabled' not in secrets_encrypt_status.stdout"

    # 2. Deploy Network Policies for Drupal namespace
    - name: Create Network Policy for Drupal
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: drupal-network-policy
            namespace: drupal
          spec:
            podSelector:
              matchLabels:
                app: drupal
            policyTypes:
            - Ingress
            - Egress
            ingress:
            - from:
              - namespaceSelector: {}
              ports:
              - protocol: TCP
                port: 80
            egress:
            - to:
              - podSelector:
                  matchLabels:
                    app: mysql
              ports:
              - protocol: TCP
                port: 3306
            - to:
              - namespaceSelector: {}
              ports:
              - protocol: TCP
                port: 53
              - protocol: UDP
                port: 53

    - name: Create Network Policy for MariaDB
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: mariadb-network-policy
            namespace: drupal
          spec:
            podSelector:
              matchLabels:
                app: mysql
            policyTypes:
            - Ingress
            - Egress
            ingress:
            - from:
              - podSelector:
                  matchLabels:
                    app: drupal
              - podSelector:
                  matchLabels:
                    app: mysql
              - namespaceSelector:
                  matchLabels:
                    kubernetes.io/metadata.name: monitoring
                podSelector:
                  matchLabels:
                    app: mysql-exporter
              ports:
              - protocol: TCP
                port: 3306
            egress:
            - to:
              - podSelector:
                  matchLabels:
                    app: mysql
              ports:
              - protocol: TCP
                port: 3306
            - to:
              - namespaceSelector: {}
              ports:
              - protocol: TCP
                port: 53
              - protocol: UDP
                port: 53

    # 3. Create RBAC roles for different access levels
    - name: Create read-only ClusterRole for monitoring
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: monitoring-reader
          rules:
          - apiGroups: [""]
            resources: ["pods", "services", "endpoints", "nodes"]
            verbs: ["get", "list", "watch"]
          - apiGroups: ["apps"]
            resources: ["deployments", "statefulsets"]
            verbs: ["get", "list", "watch"]

    - name: Create ServiceAccount for Prometheus
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: prometheus
            namespace: monitoring

    - name: Bind monitoring-reader to Prometheus
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: prometheus-monitoring
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: monitoring-reader
          subjects:
          - kind: ServiceAccount
            name: prometheus
            namespace: monitoring

    # 4. Create Pod Security Standards
    - name: Apply restricted Pod Security Standard to drupal namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: drupal
            labels:
              pod-security.kubernetes.io/enforce: restricted
              pod-security.kubernetes.io/audit: restricted
              pod-security.kubernetes.io/warn: restricted

    # 5. Create TLS certificate for Drupal (self-signed ClusterIssuer)
    - name: Create ClusterIssuer for self-signed certificates
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: selfsigned-issuer
          spec:
            selfSigned: {}

    - name: Create Certificate for Drupal
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: cert-manager.io/v1
          kind: Certificate
          metadata:
            name: drupal-tls
            namespace: drupal
          spec:
            secretName: drupal-tls-secret
            issuerRef:
              name: selfsigned-issuer
              kind: ClusterIssuer
            dnsNames:
            - drupal.example.com
            - k8s-master-1.example.com

    # 6. Security audit
    - name: Display security configuration
      debug:
        msg:
          - "=== SECURITY CONFIGURATION ==="
          - ""
          - " Secrets encryption at rest: ENABLED"
          - " Network Policies: APPLIED (drupal, mariadb)"
          - " RBAC: CONFIGURED (monitoring-reader)"
          - " Pod Security Standards: RESTRICTED (drupal namespace)"
          - " Cert-Manager: INSTALLED"
          - " TLS Certificate: CREATED (drupal-tls)"
          - ""
          - "Verify network policies: kubectl get networkpolicies -n drupal"
          - "Verify certificates: kubectl get certificates -n drupal"
          - "Verify RBAC: kubectl get clusterroles,clusterrolebindings | grep monitoring"
